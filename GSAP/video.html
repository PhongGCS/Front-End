<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSAP Video M3U8 Scroll Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="h-screen flex items-center justify-center bg-blue-600">
        <h1 class="text-4xl font-bold">Cuộn xuống để xem video (7 đoạn x 5s)</h1>
    </div>

    <div id="video-section" class="h-screen w-full flex flex-col items-center justify-center relative overflow-hidden bg-black">
        <div class="absolute top-10 left-10 z-10">
            <span id="counter" class="bg-red-600 px-4 py-2 rounded-full text-xl font-bold">Đoạn: 0/7</span>
        </div>
        
        <video id="video" class="w-full max-w-4xl shadow-2xl" muted playsinline></video>
        
        <div class="mt-4 text-gray-400">Video sẽ phát 5s mỗi lần bạn cuộn</div>
    </div>

    <div class="h-screen flex items-center justify-center bg-green-600">
        <h1 class="text-4xl font-bold">Chúc mừng! Bạn đã xem hết 7 lần cuộn.</h1>
    </div>

    <script>
        // 1. Cấu hình HLS Video
        const video = document.getElementById('video');
        const counterEl = document.getElementById('counter');
        const videoSrc = 'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_fmp4/master.m3u8';
        
        // Cấu hình logic
        let currentStepIndex = -1; // Lưu bước hiện tại để so sánh
        const maxPlays = 7;        // Tổng số đoạn
        const durationPerScroll = 5; // Mỗi đoạn dài 5 giây
        let pauseTimer = null;     // Biến để lưu bộ hẹn giờ dừng video
    
        function initVideo() {
            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc;
            }
        }
        initVideo();
    
        // 2. Cấu hình GSAP
        gsap.registerPlugin(ScrollTrigger);
    
        ScrollTrigger.create({
            trigger: "#video-section",
            start: "top top",
            end: "+=5000", 
            pin: true,
            // markers: true, // Bật lên để debug nếu cần
            onUpdate: (self) => {
                // Tính toán xem đang ở đoạn thứ mấy (Từ 0 đến maxPlays - 1)
                // Math.min để đảm bảo không vượt quá index cuối cùng khi scroll hết
                let step = Math.floor(self.progress * maxPlays);
                if (step >= maxPlays) step = maxPlays - 1; 
    
                // LOGIC QUAN TRỌNG:
                // Chỉ chạy khi Step thay đổi (Scroll xuống qua đoạn mới HOẶC Scroll lên về đoạn cũ)
                if (step !== currentStepIndex) {
                    currentStepIndex = step;
                    playSegment(currentStepIndex);
                }
            }
        });
    
        function playSegment(index) {
            // 1. Tính thời gian bắt đầu của đoạn này
            // Ví dụ: Đoạn 0 bắt đầu từ 0s, Đoạn 1 bắt đầu từ 5s...
            const startTime = index * durationPerScroll;
    
            // 2. Cập nhật giao diện đếm
            counterEl.innerText = `Đoạn: ${index + 1}/${maxPlays} (Giây: ${startTime})`;
    
            // 3. Xử lý Video
            // Tua video về đúng đầu đoạn (quan trọng cho việc scroll ngược)
            video.currentTime = startTime; 
            
            video.play().then(() => {
                // 4. Xử lý việc dừng video
                // Nếu đang có lệnh dừng cũ (do scroll nhanh), hủy nó đi để tránh dừng sai lúc
                if (pauseTimer) {
                    pauseTimer.kill();
                }
    
                // Tạo lệnh dừng mới sau 5s (durationPerScroll)
                pauseTimer = gsap.delayedCall(durationPerScroll, () => {
                    video.pause();
                    console.log(`Đã dừng đoạn ${index + 1}`);
                });
    
            }).catch(e => console.log("Cần tương tác người dùng (click) để bắt đầu video lần đầu"));
        }
    </script>
</body>
</html>