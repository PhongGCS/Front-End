<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GSAP MP4 Scroll Segment Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <style>
      body {
        margin: 0;
        background-color: #111;
        color: #fff;
        font-family: sans-serif;
      }

      .spacer {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        background: #222;
      }

      #video-section {
        width: 100%;
        height: 100vh;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* B·∫£ng th√¥ng s·ªë ƒë·ªÉ debug */
      #debug-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        z-index: 9999;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div class="spacer">üëá K√©o xu·ªëng ƒë·ªÉ b·∫Øt ƒë·∫ßu test</div>

    <section id="video-section">
      <video
        id="myVideo"
        src="./video/heka.mp4"
        muted
        playsinline
        preload="auto"
      ></video>
    </section>

    <div id="debug-panel">
      <div>Tr·∫°ng th√°i: <span id="status">ƒêang ch·ªù...</span></div>
      <div>ƒêo·∫°n (Step): <span id="step-display">0</span></div>
      <div>Th·ªùi gian video: <span id="time-display">0s</span></div>
    </div>

    <div class="spacer">H·∫øt n·ªôi dung</div>

    <script>
      gsap.registerPlugin(ScrollTrigger);

      const video = document.getElementById("myVideo");
      const statusEl = document.getElementById("status");
      const stepEl = document.getElementById("step-display");
      const timeEl = document.getElementById("time-display");

      // C·∫§U H√åNH
      const SEGMENT_DURATION = 4; // M·ªói l·∫ßn scroll ch·∫°y 4 gi√¢y
      let currentStepIndex = -1; // L∆∞u b∆∞·ªõc hi·ªán t·∫°i
      let pauseTimer = null; // Bi·∫øn l∆∞u b·ªô ƒë·∫øm gi·ªù d·ª´ng

      // ƒê·ª£i video load th√¥ng tin c∆° b·∫£n
      video.onloadedmetadata = function () {
        const totalDuration = video.duration;
        // T√≠nh t·ªïng s·ªë b∆∞·ªõc c√≥ th·ªÉ chia ƒë∆∞·ª£c
        const totalSteps = Math.floor(totalDuration / SEGMENT_DURATION);

        console.log(
          `Video d√†i: ${totalDuration}s, T·ªïng s·ªë b∆∞·ªõc: ${totalSteps}`
        );

        // T·∫°o ScrollTrigger
        ScrollTrigger.create({
          trigger: "#video-section",
          start: "top top",
          // T√≠nh chi·ªÅu d√†i scroll d·ª±a tr√™n s·ªë b∆∞·ªõc (m·ªói b∆∞·ªõc cu·ªôn 800px)
          end: "+=" + totalSteps * 800,
          pin: true,
          snap: {
            snapTo: 1 / (totalSteps - 1),
            duration: { min: 0.2, max: 0.4 },
            delay: 0.1,
            ease: "power1.inOut",
          },
          // markers: true, // B·∫≠t c√°i n√†y n·∫øu mu·ªën xem ƒëi·ªÉm b·∫Øt ƒë·∫ßu/k·∫øt th√∫c scroll
          onUpdate: (self) => {
            // T√≠nh to√°n b∆∞·ªõc hi·ªán t·∫°i d·ª±a tr√™n % scroll
            let step = Math.floor(self.progress * totalSteps);

            // Gi·ªõi h·∫°n kh√¥ng cho v∆∞·ª£t qu√° b∆∞·ªõc cu·ªëi c√πng
            if (step >= totalSteps) step = totalSteps - 1;

            // N·∫øu ng∆∞·ªùi d√πng chuy·ªÉn sang b∆∞·ªõc kh√°c (l√™n ho·∫∑c xu·ªëng)
            if (step !== currentStepIndex) {
              currentStepIndex = step;
              playSegment(currentStepIndex);
            }
          },
        });
      };

      function playSegment(index) {
        // 1. H·ªßy l·ªánh d·ª´ng c≈© (n·∫øu c√≥) ƒë·ªÉ tr√°nh video d·ª´ng ƒë·ªôt ng·ªôt khi ƒëang l∆∞·ªõt nhanh
        if (pauseTimer) pauseTimer.kill();

        // 2. T√≠nh th·ªùi gian b·∫Øt ƒë·∫ßu
        const startTime = index * SEGMENT_DURATION;

        // C·∫≠p nh·∫≠t Debug Panel
        stepEl.innerText = index + 1;
        timeEl.innerText = `${startTime}s -> ${startTime + SEGMENT_DURATION}s`;
        statusEl.innerText = "ƒêang ch·∫°y ‚ñ∂Ô∏è";

        // 3. X·ª≠ l√Ω Video
        video.currentTime = startTime; // Tua t·ªõi ƒë·∫ßu ƒëo·∫°n

        video
          .play()
          .then(() => {
            // 4. H·∫πn gi·ªù d·ª´ng sau 4 gi√¢y
            pauseTimer = gsap.delayedCall(SEGMENT_DURATION, () => {
              video.pause();
              statusEl.innerText = "ƒê√£ d·ª´ng ‚è∏Ô∏è";
            });
          })
          .catch((error) => {
            console.error("L·ªói Autoplay:", error);
            statusEl.innerText = "L·ªói: C·∫ßn click v√†o trang!";
          });
      }
    </script>
  </body>
</html>
